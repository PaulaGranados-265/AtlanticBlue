<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos Realizados - Atlantic Blue</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="css/pedidosrealizados.css">
</head>
<body class="bg-light">
  <!-- Added Bootstrap navbar with branding -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">
        <i class="bi bi-receipt me-2"></i>Atlantic Blue - Pedidos
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="panel.html">
              <i class="bi bi-house-door me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="pedidos.html">
              <i class="bi bi-plus-circle me-1"></i>Nuevo Pedido
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Added Bootstrap card container and loading state -->
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
          <i class="bi bi-list-ul text-primary me-2"></i>Pedidos Realizados
        </h4>
        <span class="badge bg-primary" id="contadorPedidos">0 pedidos</span>
      </div>
      
      <div class="card-body p-0">
        <!-- Loading state -->
        <div id="loadingState" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2 text-muted">Cargando pedidos...</p>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="text-center py-5 d-none">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h5 class="mt-3 text-muted">No hay pedidos registrados</h5>
          <p class="text-muted">Los pedidos aparecerán aquí una vez que se registren.</p>
        </div>

        <!-- Replaced basic table with responsive Bootstrap table -->
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th class="fw-semibold"># Pedido</th>
                <th class="fw-semibold">Fecha</th>
                <th class="fw-semibold d-none d-md-table-cell">Mesa</th>
                <th class="fw-semibold">Cliente</th>
                <th class="fw-semibold d-none d-lg-table-cell">Observaciones</th>
                <th class="fw-semibold d-none d-md-table-cell">Registrado por</th>
                <th class="fw-semibold text-center">Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaPedidos">
              <!-- Aquí se insertan los pedidos -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const user = JSON.parse(localStorage.getItem('user'));
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      const contadorPedidos = document.getElementById('contadorPedidos');

      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      fetch(`/pedidos?rol=${user.rol}&id_usuario=${user.id_usuario}`)
        .then(res => {
          if (!res.ok) throw new Error('Error al cargar pedidos');
          return res.json();
        })
        .then(data => {
          loadingState.classList.add('d-none');
          
          const tbody = document.getElementById('tablaPedidos');
          tbody.innerHTML = "";

          if (data.length === 0) {
            emptyState.classList.remove('d-none');
            contadorPedidos.textContent = '0 pedidos';
            return;
          }

          contadorPedidos.textContent = `${data.length} pedido${data.length !== 1 ? 's' : ''}`;

          data.forEach(pedido => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="fw-bold text-primary">#${pedido.id_pedido}</td>
              <td>
                <small class="text-muted d-block">${new Date(pedido.fecha).toLocaleDateString()}</small>
                <small class="text-muted d-md-none">${new Date(pedido.fecha).toLocaleTimeString()}</small>
              </td>
              <td class="d-none d-md-table-cell">
                <span class="badge bg-light text-dark">${pedido.mesa || '-'}</span>
              </td>
              <td>
                <div class="fw-semibold">${pedido.cliente || '-'}</div>
                <small class="text-muted d-md-none">Mesa: ${pedido.mesa || '-'}</small>
              </td>
              <td class="d-none d-lg-table-cell">
                <small class="text-muted">${pedido.observaciones || 'Sin observaciones'}</small>
              </td>
              <td class="d-none d-md-table-cell">
                <small class="text-muted">${pedido.mesero || '-'}</small>
              </td>
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-primary" onclick="editarPedido(${pedido.id_pedido})" title="Editar">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-outline-danger" onclick="eliminarPedido(${pedido.id_pedido})" title="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>
                  <button class="btn btn-outline-success" onclick="generarFactura(${pedido.id_pedido})" title="Generar Factura">
                    <i class="bi bi-receipt"></i>
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('Error:', error);
          loadingState.classList.add('d-none');
          emptyState.innerHTML = `
            <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
            <h5 class="mt-3 text-warning">Error al cargar pedidos</h5>
            <p class="text-muted">Hubo un problema al cargar los pedidos. Intenta recargar la página.</p>
            <button class="btn btn-primary" onclick="location.reload()">
              <i class="bi bi-arrow-clockwise me-1"></i>Reintentar
            </button>
          `;
          emptyState.classList.remove('d-none');
        });
    });

    function editarPedido(id) {
      window.location.href = `editar_pedido.html?id=${id}`;
    }

    function eliminarPedido(id) {
      if (confirm('¿Estás seguro de que quieres eliminar este pedido?\n\nEsta acción no se puede deshacer.')) {
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        button.disabled = true;

        fetch(`/pedido/${id}`, {
          method: 'DELETE'
        })
        .then(res => {
          if (res.ok) {
            // Show success message
            showAlert('Pedido eliminado correctamente', 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            throw new Error('Error del servidor');
          }
        })
        .catch(err => {
          console.error('Error:', err);
          showAlert('Error al eliminar el pedido', 'danger');
          button.innerHTML = originalContent;
          button.disabled = false;
        });
      }
    }

    function generarFactura(idPedido) {
      if (!confirm('¿Deseas generar la factura para este pedido?')) return;
      
      const button = event.target.closest('button');
      const originalContent = button.innerHTML;
      
      button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      button.disabled = true;

      fetch('/factura', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id_pedido: idPedido })
      })
      .then(res => {
        if (!res.ok) throw new Error('Error del servidor');
        return res.text();
      })
      .then(msg => {
        showAlert(msg || 'Factura generada correctamente', 'success');
        button.innerHTML = originalContent;
        button.disabled = false;
      })
      .catch(err => {
        console.error('Error al generar factura:', err);
        showAlert('Error al generar la factura', 'danger');
        button.innerHTML = originalContent;
        button.disabled = false;
      });
    }

    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }
  </script>
</body>
</html>
